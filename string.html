<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script>
    /** 726 OJ problem
     * @param {string} formula
     * @return {string}
     */
    const dict = {};
    var countOfAtoms = function (formula, left = 0, right = formula.length - 1, times = 1) {
        if (left > right) {
            return formulate(dict);
        }
        let seekingAtom = true, currentAtom = '', index = left;
        while (left <= right) {
            const ch = formula.charAt(left);
            if (ch == '(') {
                const num = seekingAtom ? 1 : parseInt(formula.substring(index, left));
                if (dict[currentAtom]) {
                    dict[currentAtom] += num * times;
                } else {
                    dict[currentAtom] = num * times;
                }
                let indexTmp = right;
                while (formula.charAt(indexTmp) !== ')') {
                    indexTmp--;
                }
                return countOfAtoms(formula, left + 1, indexTmp - 1, times * parseInt(formula.substring(indexTmp + 1, right + 1)));
            }
            if (seekingAtom) {
                if (/[0-9]/.test(ch)) {
                    seekingAtom = false;
                    index = left;
                } else if (/[A-Z]/.test(ch)) {
                    if (currentAtom) {
                        if (dict[currentAtom]) {
                            dict[currentAtom] += times;
                        } else {
                            dict[currentAtom] = times;
                        }
                        currentAtom = ch;
                    } else {
                        currentAtom += ch;
                    }
                } else {
                    currentAtom += ch;
                }
            } else {
                if (/[A-Z]/.test(ch)) {
                    const num = parseInt(formula.substring(index, left));
                    if (dict[currentAtom]) {
                        dict[currentAtom] += num * times;
                    } else {
                        dict[currentAtom] = num * times;
                    }
                    currentAtom = ch;
                    seekingAtom = true;
                    index = left;
                }
            }
            left++;
        }
        if (currentAtom) {
            const num = seekingAtom ? 1 : parseInt(formula.substring(index, left));
            if (dict[currentAtom]) {
                dict[currentAtom] += num * times;
            } else {
                dict[currentAtom] = num * times;
            }
        }
        return formulate(dict);
    };

    const formulate = (obj)=> {
        let ret = '';
        console.log('obj:',obj, Object.values(obj));
        Object.keys(obj).forEach(k=> {
            ret += k;
            if (obj[k] > 1) {
                ret += obj[k];
            }
        });
        return ret;
    };

//    console.log(countOfAtoms("K4(ON(SO3)2)2"), 'K4O14N2S4');
        console.log(countOfAtoms("Mg(OH)2"));


    /**
     * 767
     * @param {string} S
     * @return {string}
     */
    var reorganizeString = function (S) {
        const arr = Array.from(S);
        const len = S.length;
        const dict = new Map();
        let max = 0, keyTemp = '';
        for (let i = 0; i < len; i++) {
            const key = arr[i];
            let val = dict.get(key);
            if (val) {
                val++;
                dict.set(key, val);
                if (val > max) {
                    max = val;
                    keyTemp = key;
                }
            } else {
                dict.set(key, 1);
            }
        }
        if (max > Math.ceil(len / 2)) {
            return '';
        } else {
            for (let i = 0; i < len && max > 0; i++) {
                if (i % 2 == 0) {
                    max--;
                    if (arr[i] != keyTemp) {
                        const idx = S.indexOf(keyTemp);
                        if (idx > -1) {
                            arr[idx] = arr[i];
                            arr[i] = keyTemp;
                        }
                    }
                } else {
                    if (arr[i] == keyTemp) {
                        const idx = arr.slice(i).findIndex((el)=>el != keyTemp);
                        if (idx > -1) {
                            arr[i] = arr[idx + i];
                            arr[idx + i] = keyTemp;
                        }
                    }
                }
            }
        }
        let ret = '';
        arr.forEach((el)=>ret += el);
        return ret;
    };
    //    console.log(reorganizeString("bfrbs"));
</script>
</body>
</html>